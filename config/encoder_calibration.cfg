#####################################################################
#   ENCODER AUTO-KALIBRIERUNG â€“ AS5048A FILAMENT-MESSUNG
#####################################################################
#
#   Automatische rotation_distance Kalibrierung mittels Encoder
#   Hardware: Raspberry Pico W + AS5048A Encoder
#   Kommunikation: Bluetooth LE (BLE)
#
#####################################################################

[encoder_calibration]
# BLE Verbindung
ble_address: 28:CD:C1:07:90:00  # MAC-Adresse des Pico W (schnellere Verbindung!)
connection_timeout: 30          # Sekunden - Timeout fÃ¼r BLE-Verbindung

# Hardware-Parameter AS5048A Encoder
encoder_resolution: 16384       # AS5048A hat 14-bit AuflÃ¶sung (2^14 = 16384 steps/revolution)
wheel_diameter: 10.0            # mm - Durchmesser der Encoder-Welle/Rolle (WICHTIG: Genau messen!)
#wheel_circumference:           # mm - Wird automatisch berechnet (Ï€ Ã— diameter), kann manuell Ã¼berschrieben werden

# Kalibrierungs-Parameter
extrude_length: 100             # mm - Standard-ExtrusionslÃ¤nge pro Iteration
extrude_speed: 2                # mm/s - Geschwindigkeit beim Kalibrieren (langsam fÃ¼r Genauigkeit)
tolerance_percent: 1.0          # % - Toleranz fÃ¼r erfolgreiche Kalibrierung (1.0 = Â±1%)
max_iterations: 5               # Anzahl - Maximale Kalibrierungs-Versuche

# Safety-Parameter
min_sane_value: 50              # mm - Minimaler plausibler IST-Wert bei 100mm SOLL (Encoder-Fehler Schutz)
max_sane_value: 150             # mm - Maximaler plausibler IST-Wert bei 100mm SOLL
iteration_delay: 2.0            # Sekunden - Pause zwischen Iterationen (Filament-RÃ¼ckzug abwarten)

# Erweiterte Einstellungen
encoder_direction: 1            # 1 oder -1 - Richtung invertieren falls nÃ¶tig


#####################################################################
#   G-CODE MAKROS
#####################################################################

[gcode_macro START_ENCODER_CALIBRATION]
description: "Startet vollautomatische Encoder-basierte Kalibrierung"
gcode:
    {% set tolerance = params.TOLERANCE|default(printer.configfile.settings.encoder_calibration.tolerance_percent)|float %}
    {% set max_iter = params.MAX_ITERATIONS|default(printer.configfile.settings.encoder_calibration.max_iterations)|int %}
    {% set length = params.LENGTH|default(printer.configfile.settings.encoder_calibration.extrude_length)|float %}
    
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ¯  ENCODER AUTO-KALIBRIERUNG"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="â€¢ Extrusions-LÃ¤nge : {length} mm"
    RESPOND PREFIX="" MSG="â€¢ Toleranz         : Â±{tolerance}%"
    RESPOND PREFIX="" MSG="â€¢ Max. Versuche    : {max_iter}"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Starte Kalibrierung..."
    
    # Delegiere an Python-Modul
    ENCODER_AUTO_CALIBRATE TOLERANCE={tolerance} MAX_ITERATIONS={max_iter} LENGTH={length}


[gcode_macro ENCODER_TEST]
description: "Testet Encoder-Verbindung und zeigt Live-Werte"
gcode:
    RESPOND PREFIX="INFO" MSG="Teste Encoder-Verbindung..."
    # Delegiere an Python-Modul
    ENCODER_CONNECTION_TEST


[gcode_macro ENCODER_ZERO]
description: "Setzt Encoder-Position auf Null"
gcode:
    RESPOND PREFIX="INFO" MSG="Encoder-Position zurÃ¼ckgesetzt"
    ENCODER_RESET_POSITION


[gcode_macro ENCODER_READ]
description: "Liest aktuellen Encoder-Wert aus"
gcode:
    ENCODER_GET_POSITION


[gcode_macro ENCODER_CALIBRATE_WHEEL]
description: "Kalibriert Wellendurchmesser durch bekannte Filament-LÃ¤nge"
gcode:
    {% if 'LENGTH' not in params %}
        RESPOND PREFIX="ERROR" MSG="Parameter LENGTH fehlt! Nutzung: ENCODER_CALIBRATE_WHEEL LENGTH=<mm>"
    {% else %}
        {% set length = params.LENGTH|float %}
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="ğŸ“  ENCODER WELLEN-KALIBRIERUNG"
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="1. Markiere {length}mm Filament"
        RESPOND PREFIX="" MSG="2. FÃ¼hre Filament durch Encoder"
        RESPOND PREFIX="" MSG="3. Warte auf Berechnung..."
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Delegiere an Python-Modul
        ENCODER_CALIBRATE_DIAMETER REFERENCE_LENGTH={length}
    {% endif %}


[gcode_macro ENCODER_STATUS]
description: "Zeigt Encoder-System-Status"
gcode:
    # Delegiere direkt an Python-Modul (Header wird dort ausgegeben)
    ENCODER_PRINT_STATUS


[gcode_macro ENCODER_ALIGNMENT_TEST]
description: "Testet Sensor-Ausrichtung (10 Sekunden)"
gcode:
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ”§  SENSOR ALIGNMENT TEST"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Drehe das Encoder-Rad langsam fÃ¼r 10s"
    RESPOND PREFIX="" MSG="Der Test misst Magnet-Zentrierung..."
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Rufe Python-Funktion auf (mit _ Prefix)
    _ENCODER_ALIGNMENT_TEST


[gcode_macro ENCODER_DIAGNOSTICS_LIVE]
description: "Live Diagnostics Monitor (Toggle) - nur SSH/Serial!"
gcode:
    # Toggle: Start/Stop Monitor
    # Live-Daten gehen NUR in Pico Serial Monitor, NICHT in Mainsail Console!
    _ENCODER_DIAGNOSTICS_LIVE

 
#####################################################################
#   LUT-KALIBRIERUNG MAKRO (Optional)
#####################################################################
#
# Startet die LUT-Kalibrierung des Encoders (2 volle Umdrehungen)
# Dies ist NICHT die rotation_distance Kalibrierung!
#

[gcode_macro START_ENCODER_LUT_CALIBRATION]
description: "Startet Encoder LUT-Kalibrierung (2 Umdrehungen)"
gcode:
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ”§  ENCODER LUT-KALIBRIERUNG"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Starte 2-Umdrehungs-Kalibrierung..."
    
    # Rufe Python-Befehl auf (mit Unterstrich)
    _START_ENCODER_CALIBRATION


#####################################################################
#   HALL-SENSOR FILAMENT-DURCHMESSER (Optional)
#####################################################################
#
# Misst Filament-Durchmesser mit 2x SS49E Hall-Sensoren
# Hardware: SS49E an GPIO 26 (ADC0) und GPIO 27 (ADC1) vom Pico W
# Verwendet virtuelle ADC-Pins via BLE vom Encoder-Modul
#
# WICHTIG: Auskommentieren (#) entfernen um zu aktivieren!
#

#[hall_filament_width_sensor]
## Virtuelle ADC-Pins vom Pico W (via BLE)
#adc1: encoder:adc1
#adc2: encoder:adc2
#
## Kalibrierungs-Durchmesser (in mm)
## Messe mit 2 bekannten Filament-Durchmessern und notiere RAW-Werte
#cal_dia1: 1.50
#cal_dia2: 2.00
#
## RAW-Kalibrierungs-Werte
## Ermittle mit: QUERY_RAW_FILAMENT_WIDTH
## Pico sendet 12-bit ADC (0-4095), Klipper normalisiert zu 0.0-1.0, dann *10000
## RAW-Werte sind also 0-10000
#raw_dia1: 9500
#raw_dia2: 10500
#
## Nominal-Durchmesser deines Filaments
#default_nominal_filament_diameter: 1.75
#
## Maximale erlaubte Abweichung (in mm)
## Bei grÃ¶ÃŸerer Abweichung wird Extrusion auf 100% zurÃ¼ckgesetzt
#max_difference: 0.200
#
## Measurement Delay (in mm)
## Abstand vom Sensor zum Hotend
## Filament zwischen Sensor und Hotend wird als Nominal-Durchmesser behandelt
#measurement_delay: 70
#
## Sensor beim Start aktivieren
#enable: False
#
## Messintervall (in mm)
## Abstand zwischen Sensor-Messungen
#measurement_interval: 10
#
## Logging aktivieren
## Zeigt Durchmesser in Console/Log
#logging: False
#
## Minimaler Durchmesser (in mm)
## Triggert virtuellen filament_switch_sensor
#min_diameter: 1.0
#
## Maximaler Durchmesser (optional)
## Standard: default_nominal_filament_diameter + max_difference
##max_diameter: 1.95
#
## Aktuellen Durchmesser wÃ¤hrend Delay verwenden
## Wenn True: Nutzt aktuelle Messung statt Nominal wÃ¤hrend measurement_delay
#use_current_dia_while_delay: False
#
## Filament-Runout Parameter (optional)
## Siehe "filament_switch_sensor" Dokumentation
##pause_on_runout: True
##runout_gcode:
##insert_gcode:
##event_delay: 3.0
##pause_delay: 0.5


#####################################################################
#   DISPLAY MENÃœ - FILAMENT DURCHMESSER (Optional)
#####################################################################
#
# Zeigt Filament-Durchmesser im Display-MenÃ¼ an
# WICHTIG: Nur aktivieren wenn du ein [display] konfiguriert hast!
# Sonst gibt es einen Config-Fehler.
# Entferne die '#' am Anfang der Zeilen um zu aktivieren.
#

#[menu __main __filament __width_current]
#type: command
#enable: {'hall_filament_width_sensor' in printer}
#name: Dia: {'%.2F' % printer.hall_filament_width_sensor.Diameter}
#index: 0
#
#[menu __main __filament __raw_width_current]
#type: command
#enable: {'hall_filament_width_sensor' in printer}
#name: Raw: {'%4.0F' % printer.hall_filament_width_sensor.Raw}
#index: 1


#####################################################################
#   NOTIZEN
#####################################################################
#
# WICHTIGE SETUP-SCHRITTE:
#
# 1. WELLENDURCHMESSER MESSEN:
#    - Mit Messschieber prÃ¤zise messen (z.B. 10.05mm)
#    - In 'wheel_diameter' eintragen
#    - ODER: ENCODER_CALIBRATE_WHEEL LENGTH=100 verwenden
#
# 2. BLE MAC-ADRESSE FINDEN:
#    - Pico W einschalten
#    - SSH: sudo timeout 10 bluetoothctl scan on
#    - MAC notieren (z.B. 28:CD:C1:07:90:00)
#    - In 'ble_address' eintragen
#
# 3. ERSTE KALIBRIERUNG:
#    - Hotend aufheizen: M109 S210
#    - START_ENCODER_CALIBRATION
#    - System kalibriert automatisch!
#
# 4. HALL-SENSOR SETUP (Optional):
#    - 2x SS49E an GPIO 26 + 27 anschlieÃŸen
#    - [hall_filament_width_sensor] Sektion auskommentieren (# entfernen)
#    - Filament mit 1.50mm einlegen â†’ QUERY_RAW_FILAMENT_WIDTH â†’ raw_dia1 notieren
#    - Filament mit 2.00mm einlegen â†’ QUERY_RAW_FILAMENT_WIDTH â†’ raw_dia2 notieren
#    - Werte in Config eintragen und Klipper neu starten
#
# VERWENDUNG:
#
# - Automatische Kalibrierung:
#   START_ENCODER_CALIBRATION
#
# - Mit Custom-Parametern:
#   START_ENCODER_CALIBRATION TOLERANCE=0.5 MAX_ITERATIONS=10 LENGTH=150
#
# - Nur testen ohne Kalibrierung:
#   ENCODER_TEST
#
# - Sensor-Ausrichtung testen (NEU!):
#   ENCODER_ALIGNMENT_TEST
#   â†’ Drehe Rad 10 Sekunden
#   â†’ Bekommst Bewertung: âœ… PERFEKT / âš ï¸ MITTEL / âŒ SCHLECHT
#
# - Live Diagnostics anzeigen (NEU!) [NUR SSH!]:
#   Via SSH Terminal: ENCODER_DIAGNOSTICS_LIVE
#   â†’ Zeigt Magnitude & AGC live
#   â†’ Nochmal aufrufen zum Stoppen
#   â†’ NICHT in Mainsail nutzen (spammt Console!)
#
# - Filament-Durchmesser anzeigen (wenn Hall-Sensor aktiv):
#   QUERY_FILAMENT_WIDTH
#   QUERY_RAW_FILAMENT_WIDTH
#   â†’ Oder im Display-MenÃ¼ unter "Filament"
#
#####################################################################
