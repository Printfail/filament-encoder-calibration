#####################################################################
#   ENCODER AUTO-KALIBRIERUNG â€“ AS5048A FILAMENT-MESSUNG
#####################################################################
#
#   Automatische rotation_distance Kalibrierung mittels Encoder
#   Hardware: Raspberry Pico W + AS5048A Encoder
#   Kommunikation: Bluetooth LE (BLE)
#
#####################################################################

[encoder_calibration]
# BLE Verbindung
ble_address:  28:CD:C1:07:90:FD  # MAC-Adresse des Pico W (schnellere Verbindung!)
connection_timeout: 10          # Sekunden - Timeout fÃ¼r BLE-Verbindung (kÃ¼rzer = weniger CPU-Last)
startup_delay: 5                # Sekunden - Wartezeit vor BLE-Scan (verhindert Konflikte mit anderen BLE-Modulen wie Nevermore)

# Hardware-Parameter AS5048A Encoder
encoder_resolution: 16384       # AS5048A hat 14-bit AuflÃ¶sung (2^14 = 16384 steps/revolution)
wheel_diameter: 7.368           # mm - Durchmesser der Encoder-Welle/Rolle (WICHTIG: Genau messen!)
#wheel_circumference:           # mm - Wird automatisch berechnet (Ï€ Ã— diameter), kann manuell Ã¼berschrieben werden

# Kalibrierungs-Parameter
extrude_length: 100             # mm - Standard-ExtrusionslÃ¤nge pro Iteration
extrude_speed: 2                # mm/s - Geschwindigkeit beim Kalibrieren (langsam fÃ¼r Genauigkeit)
tolerance_percent: 1.0          # % - Toleranz fÃ¼r erfolgreiche Kalibrierung (1.0 = Â±1%)
max_iterations: 5               # Anzahl - Maximale Kalibrierungs-Versuche

# Safety-Parameter
min_sane_value: 50              # mm - Minimaler plausibler IST-Wert bei 100mm SOLL (Encoder-Fehler Schutz)
max_sane_value: 150             # mm - Maximaler plausibler IST-Wert bei 100mm SOLL
iteration_delay: 2.0            # Sekunden - Pause zwischen Iterationen (Filament-RÃ¼ckzug abwarten)

# Erweiterte Einstellungen
encoder_direction: 1            # 1 oder -1 - Richtung invertieren falls nÃ¶tig


#####################################################################
#   G-CODE MAKROS
#####################################################################

[gcode_macro START_ENCODER_CALIBRATION]
description: "Startet vollautomatische Encoder-basierte Kalibrierung"
gcode:
    {% set tolerance = params.TOLERANCE|default(printer.configfile.settings.encoder_calibration.tolerance_percent)|float %}
    {% set max_iter = params.MAX_ITERATIONS|default(printer.configfile.settings.encoder_calibration.max_iterations)|int %}
    {% set length = params.LENGTH|default(printer.configfile.settings.encoder_calibration.extrude_length)|float %}
    
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ¯  ENCODER AUTO-KALIBRIERUNG"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="â€¢ Extrusions-LÃ¤nge : {length} mm"
    RESPOND PREFIX="" MSG="â€¢ Toleranz         : Â±{tolerance}%"
    RESPOND PREFIX="" MSG="â€¢ Max. Versuche    : {max_iter}"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Starte Kalibrierung..."
    
    # Delegiere an Python-Modul
    ENCODER_AUTO_CALIBRATE TOLERANCE={tolerance} MAX_ITERATIONS={max_iter} LENGTH={length}


[gcode_macro ENCODER_TEST]
description: "Testet Encoder-Verbindung und zeigt Live-Werte"
gcode:
    RESPOND PREFIX="INFO" MSG="Teste Encoder-Verbindung..."
    # Delegiere an Python-Modul
    ENCODER_CONNECTION_TEST


[gcode_macro ENCODER_ZERO]
description: "Setzt Encoder-Position auf Null"
gcode:
    RESPOND PREFIX="INFO" MSG="Encoder-Position zurÃ¼ckgesetzt"
    ENCODER_RESET_POSITION


[gcode_macro ENCODER_READ]
description: "Liest aktuellen Encoder-Wert aus"
gcode:
    ENCODER_GET_POSITION


[gcode_macro ENCODER_CALIBRATE_WHEEL]
description: "Kalibriert Wellendurchmesser durch bekannte Filament-LÃ¤nge (mit Extrudieren)"
gcode:
    {% if 'LENGTH' not in params %}
        RESPOND PREFIX="ERROR" MSG="Parameter LENGTH fehlt! Nutzung: ENCODER_CALIBRATE_WHEEL LENGTH=<mm>"
    {% else %}
        {% set length = params.LENGTH|float %}
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="ğŸ“  ENCODER WELLEN-KALIBRIERUNG"
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="1. Markiere {length}mm Filament"
        RESPOND PREFIX="" MSG="2. FÃ¼hre Filament durch Encoder"
        RESPOND PREFIX="" MSG="3. Warte auf Berechnung..."
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Delegiere an Python-Modul
        ENCODER_CALIBRATE_DIAMETER REFERENCE_LENGTH={length}
    {% endif %}


[gcode_macro ENCODER_CALIBRATE_WHEEL_DIRECT]
description: "Kalibriert Wellendurchmesser durch manuelles Durchschieben"
gcode:
    {% set length = params.LENGTH|default(100)|float %}
    
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ“  DIREKTE WHEEL KALIBRIERUNG"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="âœ… VORTEIL: Kein Heizen nÃ¶tig!"
    RESPOND PREFIX="" MSG="âœ… VORTEIL: Sehr prÃ¤zise!"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Start calibration
    ENCODER_CALIBRATE_WHEEL_DIRECT_START LENGTH={length}


[gcode_macro ENCODER_CALIBRATE_WHEEL_DIRECT_DONE]
description: "Beendet die direkte Wheel-Kalibrierung"
gcode:
    ENCODER_CALIBRATE_WHEEL_DIRECT_FINISH


[gcode_macro ENCODER_STATUS]
description: "Zeigt Encoder-System-Status"
gcode:
    # Delegiere direkt an Python-Modul (Header wird dort ausgegeben)
    ENCODER_PRINT_STATUS


[gcode_macro ENCODER_ALIGNMENT_TEST]
description: "Testet Sensor-Ausrichtung (10 Sekunden)"
gcode:
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ”§  SENSOR ALIGNMENT TEST"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Drehe das Encoder-Rad langsam fÃ¼r 10s"
    RESPOND PREFIX="" MSG="Der Test misst Magnet-Zentrierung..."
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Rufe Python-Funktion auf (mit _ Prefix)
    _ENCODER_ALIGNMENT_TEST


[gcode_macro ENCODER_DIAGNOSTICS_LIVE]
description: "Live Diagnostics Monitor (Toggle) - nur SSH/Serial!"
gcode:
    # Toggle: Start/Stop Monitor
    # Live-Daten gehen NUR in Pico Serial Monitor, NICHT in Mainsail Console!
    _ENCODER_DIAGNOSTICS_LIVE


#####################################################################
#   HALL-SENSOR FILAMENT-DURCHMESSER (Optional)
#####################################################################
#
# Misst Filament-Durchmesser mit 2x SS49E Hall-Sensoren
# Hardware: SS49E an GPIO 26 (ADC0) und GPIO 27 (ADC1) vom Pico W
# Verwendet virtuelle ADC-Pins via BLE vom Encoder-Modul
#
# WICHTIG: Auskommentieren (#) entfernen um zu aktivieren!
#

[hall_filament_width_sensor]
# Virtuelle ADC-Pins vom Pico W (via BLE)
adc1: encoder:adc1
adc2: encoder:adc2

# Kalibrierungs-Durchmesser (in mm)
# Messe mit 2 bekannten Filament-Durchmessern und notiere RAW-Werte
# WICHTIG: Diese Werte MÃœSSEN kalibriert werden!
cal_dia1: 1.487
cal_dia2: 1.994

# RAW-Kalibrierungs-Werte
# Ermittle mit: QUERY_RAW_FILAMENT_WIDTH
# Pico sendet 12-bit ADC (0-4095), Klipper normalisiert zu 0.0-1.0, dann *10000
# RAW-Werte sind also 0-10000
# WICHTIG: Diese Dummy-Werte MÃœSSEN durch echte Messwerte ersetzt werden!
raw_dia1: 10381
raw_dia2: 11006

# Nominal-Durchmesser deines Filaments
default_nominal_filament_diameter: 1.75

# Maximale erlaubte Abweichung (in mm)
# Bei grÃ¶ÃŸerer Abweichung wird Extrusion auf 100% zurÃ¼ckgesetzt
max_difference: 0.200

# Measurement Delay (in mm)
# Abstand vom Sensor zum Hotend
# Filament zwischen Sensor und Hotend wird als Nominal-Durchmesser behandelt
measurement_delay: 70

# Sensor beim Start aktivieren
enable: True

# Messintervall (in mm)
# Abstand zwischen Sensor-Messungen
measurement_interval: 2

# Logging aktivieren
# Zeigt Durchmesser in Console/Log
logging: True

# Minimaler Durchmesser (in mm)
# Triggert virtuellen filament_switch_sensor
min_diameter: 1.0

# Maximaler Durchmesser (optional)
# Standard: default_nominal_filament_diameter + max_difference
max_diameter: 1.95

# Aktuellen Durchmesser wÃ¤hrend Delay verwenden
# Wenn True: Nutzt aktuelle Messung statt Nominal wÃ¤hrend measurement_delay
use_current_dia_while_delay: False

# Filament-Runout Parameter (optional)
# Siehe "filament_switch_sensor" Dokumentation
#pause_on_runout: True
#runout_gcode:
#insert_gcode:
#event_delay: 3.0
#pause_delay: 0.5


#####################################################################
#   MAX FLOW RATE TEST (NEU!)
#####################################################################

[gcode_macro START_MAX_FLOW_TEST]
description: ğŸ”¥ Misst maximalen Hotend-Flow durch Extruder-Slip-Detection
gcode:
    # Parameter mit Defaults (fÃ¼r Mainsail UI sichtbar)
    {% set start_speed = params.START_SPEED|default(1)|float %}
    {% set end_speed = params.END_SPEED|default(25)|float %}
    {% set step = params.STEP|default(1)|float %}
    {% set extrude_length = params.EXTRUDE_LENGTH|default(50)|float %}
    {% set tolerance = params.TOLERANCE|default(95)|float %}
    {% set filament_dia = params.FILAMENT_DIA|default(1.75)|float %}
    {% set target_temp = params.TARGET_TEMP|default(210)|float %}
    
    # Heize Hotend auf (wartet bis Temperatur erreicht)
    M109 S{target_temp}
    
    # Rufe Python-Command mit allen Parametern auf
    _START_MAX_FLOW_TEST START_SPEED={start_speed} END_SPEED={end_speed} STEP={step} EXTRUDE_LENGTH={extrude_length} TOLERANCE={tolerance} FILAMENT_DIA={filament_dia} TARGET_TEMP={target_temp}


#####################################################################
#   NOTIZEN
#####################################################################
#
# WICHTIGE SETUP-SCHRITTE:
#
# 1. WELLENDURCHMESSER MESSEN:
#    - Mit Messschieber prÃ¤zise messen (z.B. 10.05mm)
#    - In 'wheel_diameter' eintragen
#    - ODER: ENCODER_CALIBRATE_WHEEL LENGTH=100 verwenden
#
# 2. BLE MAC-ADRESSE FINDEN:
#    - Pico W einschalten
#    - SSH: sudo timeout 10 bluetoothctl scan on
#    - MAC notieren (z.B. 28:CD:C1:07:90:00)
#    - In 'ble_address' eintragen
#
# 3. ERSTE KALIBRIERUNG:
#    - Hotend aufheizen: M109 S210
#    - START_ENCODER_CALIBRATION
#    - System kalibriert automatisch!
#
# 4. HALL-SENSOR SETUP (Optional):
#    - 2x SS49E an GPIO 26 + 27 anschlieÃŸen
#    - [hall_filament_width_sensor] Sektion auskommentieren (# entfernen)
#    - Filament mit 1.50mm einlegen â†’ QUERY_RAW_FILAMENT_WIDTH â†’ raw_dia1 notieren
#    - Filament mit 2.00mm einlegen â†’ QUERY_RAW_FILAMENT_WIDTH â†’ raw_dia2 notieren
#    - Werte in Config eintragen und Klipper neu starten
#
# VERWENDUNG:
#
# - Automatische Kalibrierung:
#   START_ENCODER_CALIBRATION
#
# - Mit Custom-Parametern:
#   START_ENCODER_CALIBRATION TOLERANCE=0.5 MAX_ITERATIONS=10 LENGTH=150
#
# - Nur testen ohne Kalibrierung:
#   ENCODER_TEST
#
# - Sensor-Ausrichtung testen (NEU!):
#   ENCODER_ALIGNMENT_TEST
#   â†’ Drehe Rad 10 Sekunden
#   â†’ Bekommst Bewertung: âœ… PERFEKT / âš ï¸ MITTEL / âŒ SCHLECHT
#
# - Live Diagnostics anzeigen (NEU!) [NUR SSH!]:
#   Via SSH Terminal: ENCODER_DIAGNOSTICS_LIVE
#   â†’ Zeigt Magnitude & AGC live
#   â†’ Nochmal aufrufen zum Stoppen
#   â†’ NICHT in Mainsail nutzen (spammt Console!)
#
# - MAX Flow Rate Test (NEU!) ğŸ”¥:
#   START_MAX_FLOW_TEST TARGET_TEMP=210
#   â†’ Heizt automatisch auf & testet Hotend-Schmelzrate
#   â†’ Misst bei welcher Geschwindigkeit Extruder rutscht
#   â†’ Gibt maximalen Flow in mmÂ³/s aus
#   â†’ Perfekt fÃ¼r Hotend-Tuning & Slicer-Einstellungen!
#
# - Filament-Durchmesser anzeigen (wenn Hall-Sensor aktiv):
#   QUERY_FILAMENT_WIDTH
#   QUERY_RAW_FILAMENT_WIDTH
#   â†’ Oder im Display-MenÃ¼ unter "Filament"
#
#####################################################################
