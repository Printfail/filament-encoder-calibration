#####################################################################
#   ENCODER AUTO-KALIBRIERUNG â€“ AS5048A FILAMENT-MESSUNG
#####################################################################
#
#   Automatische rotation_distance Kalibrierung mittels Encoder
#   Hardware: Raspberry Pico W + AS5048A Encoder
#   Kommunikation: Bluetooth LE (BLE)
#
#####################################################################

[encoder_calibration]
# BLE Verbindung
ble_address: 28:CD:C1:07:90:00  # MAC-Adresse des Pico W (schnellere Verbindung!)
connection_timeout: 30          # Sekunden - Timeout fÃ¼r BLE-Verbindung

# Hardware-Parameter AS5048A Encoder
encoder_resolution: 16384       # AS5048A hat 14-bit AuflÃ¶sung (2^14 = 16384 steps/revolution)
wheel_diameter: 10.0            # mm - Durchmesser der Encoder-Welle/Rolle (WICHTIG: Genau messen!)
#wheel_circumference:           # mm - Wird automatisch berechnet (Ï€ Ã— diameter), kann manuell Ã¼berschrieben werden

# Kalibrierungs-Parameter
extrude_length: 100             # mm - Standard-ExtrusionslÃ¤nge pro Iteration
extrude_speed: 2                # mm/s - Geschwindigkeit beim Kalibrieren (langsam fÃ¼r Genauigkeit)
tolerance_percent: 1.0          # % - Toleranz fÃ¼r erfolgreiche Kalibrierung (1.0 = Â±1%)
max_iterations: 5               # Anzahl - Maximale Kalibrierungs-Versuche

# Safety-Parameter
min_sane_value: 50              # mm - Minimaler plausibler IST-Wert bei 100mm SOLL (Encoder-Fehler Schutz)
max_sane_value: 150             # mm - Maximaler plausibler IST-Wert bei 100mm SOLL
iteration_delay: 2.0            # Sekunden - Pause zwischen Iterationen (Filament-RÃ¼ckzug abwarten)

# Erweiterte Einstellungen
encoder_direction: 1            # 1 oder -1 - Richtung invertieren falls nÃ¶tig


#####################################################################
#   G-CODE MAKROS
#####################################################################

[gcode_macro START_ENCODER_CALIBRATION]
description: "Startet vollautomatische Encoder-basierte Kalibrierung"
gcode:
    {% set tolerance = params.TOLERANCE|default(printer.configfile.settings.encoder_calibration.tolerance_percent)|float %}
    {% set max_iter = params.MAX_ITERATIONS|default(printer.configfile.settings.encoder_calibration.max_iterations)|int %}
    {% set length = params.LENGTH|default(printer.configfile.settings.encoder_calibration.extrude_length)|float %}
    
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="ğŸ¯  ENCODER AUTO-KALIBRIERUNG"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="â€¢ Extrusions-LÃ¤nge : {length} mm"
    RESPOND PREFIX="" MSG="â€¢ Toleranz         : Â±{tolerance}%"
    RESPOND PREFIX="" MSG="â€¢ Max. Versuche    : {max_iter}"
    RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND PREFIX="" MSG="Starte Kalibrierung..."
    
    # Delegiere an Python-Modul
    ENCODER_AUTO_CALIBRATE TOLERANCE={tolerance} MAX_ITERATIONS={max_iter} LENGTH={length}


[gcode_macro ENCODER_TEST]
description: "Testet Encoder-Verbindung und zeigt Live-Werte"
gcode:
    RESPOND PREFIX="INFO" MSG="Teste Encoder-Verbindung..."
    # Delegiere an Python-Modul
    ENCODER_CONNECTION_TEST


[gcode_macro ENCODER_ZERO]
description: "Setzt Encoder-Position auf Null"
gcode:
    RESPOND PREFIX="INFO" MSG="Encoder-Position zurÃ¼ckgesetzt"
    ENCODER_RESET_POSITION


[gcode_macro ENCODER_READ]
description: "Liest aktuellen Encoder-Wert aus"
gcode:
    ENCODER_GET_POSITION


[gcode_macro ENCODER_CALIBRATE_WHEEL]
description: "Kalibriert Wellendurchmesser durch bekannte Filament-LÃ¤nge"
gcode:
    {% if 'LENGTH' not in params %}
        RESPOND PREFIX="ERROR" MSG="Parameter LENGTH fehlt! Nutzung: ENCODER_CALIBRATE_WHEEL LENGTH=<mm>"
    {% else %}
        {% set length = params.LENGTH|float %}
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="ğŸ“  ENCODER WELLEN-KALIBRIERUNG"
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        RESPOND PREFIX="" MSG="1. Markiere {length}mm Filament"
        RESPOND PREFIX="" MSG="2. FÃ¼hre Filament durch Encoder"
        RESPOND PREFIX="" MSG="3. Warte auf Berechnung..."
        RESPOND PREFIX="" MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Delegiere an Python-Modul
        ENCODER_CALIBRATE_DIAMETER REFERENCE_LENGTH={length}
    {% endif %}


[gcode_macro ENCODER_STATUS]
description: "Zeigt Encoder-System-Status"
gcode:
    # Delegiere direkt an Python-Modul (Header wird dort ausgegeben)
    ENCODER_PRINT_STATUS


#####################################################################
#   NOTIZEN
#####################################################################
#
# WICHTIGE SETUP-SCHRITTE:
#
# 1. WELLENDURCHMESSER MESSEN:
#    - Mit Messschieber prÃ¤zise messen (z.B. 10.05mm)
#    - In 'wheel_diameter' eintragen
#    - ODER: ENCODER_CALIBRATE_WHEEL LENGTH=100 verwenden
#
# 2. BLE ADRESSE ERMITTELN:
#    - Pico W flashen und starten
#    - Adresse aus Serial Log kopieren
#    - In 'ble_address' eintragen
#
# 3. ENCODER RICHTUNG PRÃœFEN:
#    - ENCODER_TEST ausfÃ¼hren
#    - Filament manuell durchziehen
#    - Falls Wert negativ wird â†’ 'encoder_direction: -1'
#
# 4. ERSTE KALIBRIERUNG:
#    - START_ENCODER_CALIBRATION
#    - System kalibriert automatisch
#
# VERWENDUNG:
#
# - Automatische Kalibrierung:
#   START_ENCODER_CALIBRATION
#
# - Mit Custom-Parametern:
#   START_ENCODER_CALIBRATION TOLERANCE=0.5 MAX_ITERATIONS=10 LENGTH=150
#
# - Nur testen ohne Kalibrierung:
#   ENCODER_TEST
#
#####################################################################
