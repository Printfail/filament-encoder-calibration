#####################################################################
#   DYNAMISCHE EXTRUDER ROTATION DISTANCE â€“ ÃœBER mmu_vars.cfg
#####################################################################

[gcode_macro CHECK_ROTATION_DISTANCE]
description: "Zeigt gespeicherten und aktiven Wert"
gcode:
    {% set saved = (printer.save_variables.variables.rotation_distance
                    |default(printer.configfile.settings.extruder.rotation_distance))|float %}
    {% set config = printer.configfile.settings.extruder.rotation_distance|float %}
    RESPOND PREFIX="INFO" MSG="Gespeichert: {saved} | Config: {config}"


[gcode_macro LOAD_EXTRUDER_SETTINGS]
description: "LÃ¤dt gespeicherten rotation_distance beim Start"
gcode:
    {% set vars = printer.save_variables.variables|default({}) %}
    {% set val = (vars.rotation_distance|default(printer.configfile.settings.extruder.rotation_distance))|float %}
    SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={val}
    RESPOND PREFIX="INFO" MSG="rotation_distance geladen: {val}"

[gcode_macro SET_ROTATION_DISTANCE_LIVE]
description: "Ã„ndert rotation_distance live und speichert in mmu_vars.cfg"
gcode:
    {% if 'VALUE' in params %}
        {% set val = params.VALUE|float %}
        {% if val > 0 %}
            # Live anwenden
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={val}
            # Persistieren (offizieller Befehl des save_variables-Moduls)
            SAVE_VARIABLE VARIABLE=rotation_distance VALUE={val}
            RESPOND PREFIX="INFO" MSG="rotation_distance live geÃ¤ndert und gespeichert: {val}"
            M117 rotation_distance: {val}
        {% else %}
            RESPOND PREFIX="ERROR" MSG="VALUE muss > 0 sein"
        {% endif %}
    {% else %}
        RESPOND PREFIX="ERROR" MSG="Parameter fehlt: VALUE=<Wert>"
    {% endif %}

[delayed_gcode LOAD_EXTRUDER_ON_BOOT]
initial_duration: 5
gcode:
    LOAD_EXTRUDER_SETTINGS


#####################################################################
#   AUTO CALC ROTATION_DISTANCE â€“ ROBUSTE EXTRUDER-KALIBRIERUNG
#####################################################################

[gcode_macro AUTO_CALC_ROTATION_DISTANCE]
description: "Berechnet neue rotation_distance automatisch aus REF, EXTRUDE und REST"
gcode:
    {% if 'REF' in params and 'EXTRUDE' in params and 'REST' in params %}
        {% set ref = params.REF|default(120)|float %}
        {% set extrude = params.EXTRUDE|default(100)|float %}
        {% set rest = params.REST|default(20)|float %}
        {% set ist = ref - rest %}
        {% set soll = extrude %}

        {% set vars = printer.save_variables.variables|default({}) %}
        {% set old_val = (vars.rotation_distance|default(printer.configfile.settings.extruder.rotation_distance))|float %}
        {% set new_val = old_val * (ist / soll) %}

        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="ğŸ¯  ROTATION_DISTANCE AUTOKALIBRIERUNG"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Referenz   : { '%0.3f' % (ref) } mm"
        RESPOND PREFIX="" MSG="â€¢ Extrudiert : { '%0.3f' % (extrude) } mm"
        RESPOND PREFIX="" MSG="â€¢ Rest       : { '%0.3f' % (rest) } mm"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Berechnet  : Ist={ '%0.3f' % (ist) } mm | Soll={ '%0.3f' % (soll) } mm"
        RESPOND PREFIX="" MSG="â€¢ Formel     : { '%0.6f' % (old_val) } x ({ '%0.3f' % (ist) } / { '%0.3f' % (soll) })"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Alter Wert : { '%0.6f' % (old_val) }"
        RESPOND PREFIX="" MSG="â€¢ Neuer Wert : { '%0.6f' % (new_val) }"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"


        SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={new_val}
        SAVE_VARIABLE VARIABLE=rotation_distance VALUE={new_val}

        RESPOND PREFIX="INFO" MSG="âœ… rotation_distance gesetzt und gespeichert: { '%0.6f' % (new_val) }"
    {% else %}
        RESPOND PREFIX="ERROR" MSG="Fehlende Parameter! Nutzung: AUTO_CALC_ROTATION_DISTANCE REF=<mm> EXTRUDE=<mm> REST=<mm>"
    {% endif %}

[gcode_macro AUTO_CALC_ROTATION_DISTANCE_DIRECT]
description: "Berechnet neue rotation_distance aus direkter Messung (SOLL vs IST)"
gcode:
    {% if 'SOLL' in params and 'IST' in params %}
        {% set soll = params.SOLL|float %}
        {% set ist = params.IST|float %}

        {% set vars = printer.save_variables.variables|default({}) %}
        {% set old_val = (vars.rotation_distance|default(printer.configfile.settings.extruder.rotation_distance))|float %}
        {% set new_val = old_val * (ist / soll) %}

        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="ğŸ“  ROTATION_DISTANCE DIREKTMESSUNG"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Soll extrudiert : { '%0.3f' % (soll) } mm"
        RESPOND PREFIX="" MSG="â€¢ Ist gemessen    : { '%0.3f' % (ist) } mm"
        RESPOND PREFIX="" MSG="â€¢ Differenz       : { '%0.3f' % (ist - soll) } mm"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Formel     : { '%0.6f' % (old_val) } x ({ '%0.3f' % (ist) } / { '%0.3f' % (soll) })"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        RESPOND PREFIX="" MSG="â€¢ Alter Wert : { '%0.6f' % (old_val) }"
        RESPOND PREFIX="" MSG="â€¢ Neuer Wert : { '%0.6f' % (new_val) }"
        RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"


        SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={new_val}
        SAVE_VARIABLE VARIABLE=rotation_distance VALUE={new_val}

        RESPOND PREFIX="INFO" MSG="âœ… rotation_distance gesetzt und gespeichert: { '%0.6f' % (new_val) }"
    {% else %}
        RESPOND PREFIX="ERROR" MSG="Fehlende Parameter! Nutzung: AUTO_CALC_ROTATION_DISTANCE_DIRECT SOLL=<mm> IST=<mm>"
    {% endif %}

[gcode_macro EXTRUDER_CALIBRATION]
description: "Extrudiert benutzerdefinierte LÃ¤nge mit frei wÃ¤hlbarer Geschwindigkeit"
gcode:
    {% set dist = params.DIST|default(100)|float %}
    {% set speed = params.SPEED|default(2)|float * 60 %}  # mm/s â†’ mm/min

    RESPOND PREFIX="" MSG="â€¢ LÃ¤nge           : {dist} mm"
    RESPOND PREFIX="" MSG="â€¢ Geschwindigkeit : {(speed/60)|round(2)} mm/s"
    RESPOND PREFIX="" MSG="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    RESPOND PREFIX="" MSG="Starte Extrusion..."

    M83                             ; Relativer Modus
    G1 E{dist} F{speed}             ; Extrudiere
    #RESPOND PREFIX="INFO" MSG="âœ… Extrusion abgeschlossen"


